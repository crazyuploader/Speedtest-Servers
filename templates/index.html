<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Speedtest Servers Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Montserrat:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Basic custom styles that Tailwind doesn't directly cover or for overrides */
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        /* Apply a default font for the body */
        font-family: "Poppins", sans-serif;
      }
      main {
        flex-grow: 1;
      }
      /* Custom scrollbar for table on smaller screens */
      .table-container {
        overflow-x: auto;
        overflow-y: visible;
        /* Ensure table content doesn't break out on very small screens */
        -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
        /* Make sure the container itself has proper scrolling */
        width: 100%;
        display: block;
      }

      /* Reduce table cell padding on small screens for better fit */
      @media (max-width: 640px) {
        /* Tailwind's 'sm' breakpoint */
        .table-container th,
        .table-container td {
          padding-left: 0.5rem; /* px-2 */
          padding-right: 0.5rem; /* px-2 */
          padding-top: 0.5rem; /* py-2 */
          padding-bottom: 0.5rem; /* py-2 */
          font-size: 0.75rem; /* text-xs */
        }
        /* Further reduce padding for the first column if necessary */
        .table-container th:first-child,
        .table-container td:first-child {
          padding-left: 0.25rem; /* px-1 */
        }
      }

      /* --- Spinner Styles --- */
      .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(
          255,
          255,
          255,
          0.9
        ); /* Semi-transparent white background */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* Ensure it's on top of everything */
        transition: opacity 0.3s ease-in-out;
      }

      .spinner-overlay.hidden {
        opacity: 0;
        visibility: hidden;
      }

      .spinner {
        border: 8px solid #f3f3f3; /* Light grey */
        border-top: 8px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite; /* Spin animation */
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- Table Styles --- */
      #servers {
        /* Set minimum width to ensure table is wide enough to scroll */
        min-width: 800px; /* Adjusted for fewer columns */
        width: 100%;
        display: table;
      }

      /* Desktop styles - use fixed layout for consistent column widths */
      @media (min-width: 769px) {
        #servers {
          table-layout: fixed;
        }

        /* Adjusted widths for 8 columns on desktop */
        #servers th:nth-child(1),
        #servers td:nth-child(1) {
          width: 5%; /* # */
        }
        #servers th:nth-child(2),
        #servers td:nth-child(2) {
          width: 15%; /* City */
        }
        #servers th:nth-child(3),
        #servers td:nth-child(3) {
          width: 10%; /* Country */
        }
        #servers th:nth-child(4),
        #servers td:nth-child(4) {
          width: 20%; /* Sponsor */
        }
        #servers th:nth-child(5),
        #servers td:nth-child(5) {
          width: 10%; /* Server ID */
        }
        #servers th:nth-child(6),
        #servers td:nth-child(6) {
          width: 8%; /* HTTPS */
        }
        #servers th:nth-child(7),
        #servers td:nth-child(7) {
          width: 8%; /* IPv6 */
        }
        #servers th:nth-child(8),
        #servers td:nth-child(8) {
          width: 24%; /* Host */
        }
      }

      /* Mobile styles - use auto layout and prevent text wrapping */
      @media (max-width: 768px) {
        .table-container {
          border-radius: 0.5rem;
          overflow-x: scroll !important;
          overflow-y: visible;
          -webkit-overflow-scrolling: touch;
          width: 100%;
          display: block;
        }

        #servers {
          table-layout: auto;
          min-width: 880px; /* Adjusted for fewer columns */
          display: table;
        }

        #servers th,
        #servers td {
          white-space: nowrap; /* Prevent text from wrapping */
          min-width: 80px; /* Minimum width for each column */
        }

        /* Specific minimum widths for mobile */
        #servers th:nth-child(1),
        #servers td:nth-child(1) {
          min-width: 40px; /* # */
        }
        #servers th:nth-child(2),
        #servers td:nth-child(2) {
          min-width: 120px; /* City */
        }
        #servers th:nth-child(3),
        #servers td:nth-child(3) {
          min-width: 100px; /* Country */
        }
        #servers th:nth-child(4),
        #servers td:nth-child(4) {
          min-width: 180px; /* Sponsor */
        }
        #servers th:nth-child(5),
        #servers td:nth-child(5) {
          min-width: 80px; /* Server ID */
        }
        #servers th:nth-child(6),
        #servers td:nth-child(6) {
          min-width: 70px; /* HTTPS */
        }
        #servers th:nth-child(7),
        #servers td:nth-child(7) {
          min-width: 90px; /* IPv6 */
        }
        #servers th:nth-child(8),
        #servers td:nth-child(8) {
          min-width: 200px; /* Host */
        }
      }

      /* --- Tooltip Styles --- */
      #ip-tooltip {
        position: absolute;
        background-color: #333;
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        z-index: 10000; /* Above everything else */
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.2s ease-in-out,
          visibility 0.2s ease-in-out;
        pointer-events: none; /* Allows clicks to pass through to elements beneath */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        max-width: 300px; /* INCREASED WIDTH */
        min-width: 200px; /* Added minimum width */
      }
      #ip-tooltip.visible {
        opacity: 1;
        visibility: visible;
      }
      #ip-tooltip p {
        margin: 0;
        line-height: 1.4;
        /* Removed word-break: break-all; */
      }
      #ip-tooltip p:not(:last-child) {
        margin-bottom: 4px;
      }
      #ip-tooltip strong {
        color: #a8dadc; /* A slight highlight for labels */
      }

      /* Status indicator dot (kept for potential future use, though not displayed) */
      .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
        vertical-align: middle;
      }
      .status-online {
        background-color: #22c55e; /* green-500 */
      }
      .status-offline {
        background-color: #ef4444; /* red-500 */
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800 antialiased flex flex-col min-h-screen">
    <div id="spinner" class="spinner-overlay hidden">
      <div class="spinner"></div>
    </div>

    <div id="ip-tooltip"></div>

    <header
      class="bg-gradient-to-r from-blue-700 to-purple-600 p-4 sm:p-6 shadow-lg"
    >
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <h1
          class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-white text-center sm:text-left tracking-tight font-['Montserrat']"
        >
          Enhanced Speedtest Servers Dashboard
        </h1>
      </div>
    </header>

    <main
      class="container mx-auto mt-6 sm:mt-10 p-4 sm:p-6 bg-white rounded-xl shadow-2xl flex-grow border border-gray-100"
    >
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6 sm:mb-8"
      >
        <!-- ISP Selector -->
        <div>
          <label
            for="provider"
            class="block text-lg sm:text-xl font-semibold text-gray-700 mb-3"
            >Choose an ISP/Network:</label
          >
          <div class="relative">
            <select
              id="provider"
              class="block appearance-none w-full bg-white border border-gray-300 text-gray-800 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300 ease-in-out text-base sm:text-lg shadow-sm"
            ></select>
            <div
              class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-600"
            >
              <svg
                class="fill-current h-5 w-5"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
              >
                <path
                  d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                />
              </svg>
            </div>
          </div>
        </div>

        <!-- Country Filter -->
        <div>
          <label
            for="countryFilter"
            class="block text-lg sm:text-xl font-semibold text-gray-700 mb-3"
            >Filter by Country:</label
          >
          <div class="relative">
            <select
              id="countryFilter"
              class="block appearance-none w-full bg-white border border-gray-300 text-gray-800 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300 ease-in-out text-base sm:text-lg shadow-sm"
            >
              <option value="">All Countries</option>
            </select>
            <div
              class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-600"
            >
              <svg
                class="fill-current h-5 w-5"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
              >
                <path
                  d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                />
              </svg>
            </div>
          </div>
        </div>

        <!-- Search Bar -->
        <div>
          <label
            for="searchServers"
            class="block text-lg sm:text-xl font-semibold text-gray-700 mb-3"
            >Search Servers:</label
          >
          <input
            type="text"
            id="searchServers"
            placeholder="Search by city, sponsor, host, ID..."
            class="block w-full bg-white border border-gray-300 text-gray-800 py-3 px-4 rounded-lg leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300 ease-in-out text-base sm:text-lg shadow-sm"
          />
        </div>
      </div>

      <div
        id="metadata"
        class="text-sm sm:text-base text-gray-700 mb-6 sm:mb-8 p-4 bg-blue-50 rounded-lg border border-blue-200 shadow-inner"
      ></div>

      <div
        id="scroll-hint"
        class="block sm:hidden mb-3 text-center text-sm text-gray-500 italic"
      >
        <svg
          class="inline w-4 h-4 mr-1"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 16l-4-4m0 0l4-4m-4 4h18"
          />
        </svg>
        Scroll horizontally to view all data
        <svg
          class="inline w-4 h-4 ml-1"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 8l4 4m0 0l-4 4m4-4H3"
          />
        </svg>
      </div>

      <div
        class="table-container shadow-lg rounded-lg overflow-hidden border border-gray-200 bg-white"
      >
        <table id="servers" class="divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                #
              </th>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                City
              </th>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Country
              </th>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Sponsor
              </th>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Server ID
              </th>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                HTTPS
              </th>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                IPv6 Capable
              </th>
              <th
                scope="col"
                class="px-4 py-3 sm:px-6 sm:py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Host
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100"></tbody>
        </table>
      </div>
    </main>

    <footer
      class="bg-gray-900 text-white text-center p-4 sm:p-5 mt-8 sm:mt-12 shadow-inner text-sm sm:text-base"
    >
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <p>
          &copy; 2025 Enhanced Speedtest Servers Dashboard. All rights reserved.
        </p>
      </div>
    </footer>

    <script>
      const selectProvider = document.getElementById("provider"); // ISP dropdown element
      const selectCountryFilter = document.getElementById("countryFilter"); // Country filter dropdown
      const searchServersInput = document.getElementById("searchServers"); // Search input
      const tbody = document.querySelector("tbody"); // table body where rows go
      const metadataDiv = document.getElementById("metadata"); // metadata div
      const spinner = document.getElementById("spinner"); // spinner element
      const ipTooltip = document.getElementById("ip-tooltip"); // Tooltip element

      // In-memory cache for already-fetched JSON data
      const cachedData = {};
      let currentISPData = null; // Stores the currently selected ISP's full data

      // Helper to show the spinner
      function showSpinner() {
        spinner.classList.remove("hidden");
      }

      // Helper to hide the spinner
      function hideSpinner() {
        spinner.classList.add("hidden");
      }

      // Helper to convert slugified directory names to readable labels
      // 'you-broadband-india' → 'You Broadband India'
      const formatName = (str) =>
        str
          .split("-")
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");

      // Function to populate the country filter dropdown
      function populateCountryFilter(servers) {
        const countries = new Set();
        servers.forEach((server) => {
          if (server.country) {
            countries.add(server.country);
          }
        });
        const sortedCountries = Array.from(countries).sort();

        selectCountryFilter.innerHTML =
          '<option value="">All Countries</option>';
        sortedCountries.forEach((country) => {
          const option = document.createElement("option");
          option.value = country;
          option.textContent = country;
          selectCountryFilter.appendChild(option);
        });
      }

      // Load all ISPs listed from the server
      async function loadProviders() {
        showSpinner(); // Show spinner before starting to fetch data
        try {
          const res = await fetch("/list");
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          const dirs = await res.json(); // array of directory names like 'jio', 'hathway'
          const options = [];

          // For each ISP directory, fetch the servers.json file
          for (const dir of dirs) {
            try {
              const jsonRes = await fetch(`/data/${dir}/servers.json`);
              if (!jsonRes.ok) {
                console.warn(
                  `Failed to fetch data for ${dir}: HTTP error! status: ${jsonRes.status}`,
                );
                continue; // Skip to the next directory
              }
              const data = await jsonRes.json();

              // Cache this JSON for later use (avoids re-fetching)
              cachedData[dir] = data;

              // Label for dropdown: use sponsor name or fallback to formatted dir name
              const label = data.servers?.[0]?.sponsor || formatName(dir);
              options.push({ value: dir, label });
            } catch (err) {
              console.warn(`Failed to process data for ${dir}:`, err);
            }
          }

          // Sort ISPs alphabetically by sponsor name
          options.sort((a, b) => a.label.localeCompare(b.label));

          // Render dropdown options
          selectProvider.innerHTML = options
            .map((opt) => `<option value="${opt.value}">${opt.label}</option>`)
            .join("");

          // Load the first ISP by default
          if (options.length > 0) {
            // Reset filters when a new ISP is loaded
            selectCountryFilter.value = "";
            searchServersInput.value = "";
            loadServers(options[0].value);
          } else {
            metadataDiv.innerHTML = `<p class="text-red-600">No ISP data available.</p>`;
          }
        } catch (err) {
          console.error("Error loading providers:", err);
          metadataDiv.innerHTML = `<p class="text-red-600">Failed to load ISP list. Please check the server connection.</p>`;
        } finally {
          hideSpinner(); // Hide spinner after all data is fetched or an error occurs
        }
      }

      // Load server data from cachedData, apply filters, and display it in the table
      function loadServers(isp, countryFilter = "", searchTerm = "") {
        const data = cachedData[isp];
        currentISPData = data; // Store the full data for current ISP

        if (!data || !data.servers) {
          // Colspan is now 8
          tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No server data found for this ISP.</td></tr>`;
          metadataDiv.innerHTML = `<p class="text-red-600">No data available for the selected ISP.</p>`;
          populateCountryFilter([]); // Clear country filter
          return;
        }

        let filteredServers = data.servers; // No simulation needed if columns are removed

        // Apply country filter
        if (countryFilter) {
          filteredServers = filteredServers.filter(
            (server) => server.country === countryFilter,
          );
        }

        // Apply search term filter
        if (searchTerm) {
          const lowerCaseSearchTerm = searchTerm.toLowerCase();
          filteredServers = filteredServers.filter(
            (server) =>
              server.name.toLowerCase().includes(lowerCaseSearchTerm) ||
              server.sponsor.toLowerCase().includes(lowerCaseSearchTerm) ||
              server.host.toLowerCase().includes(lowerCaseSearchTerm) ||
              server.id.includes(lowerCaseSearchTerm),
          );
        }

        // Populate country filter based on the *original* full data for the ISP
        populateCountryFilter(data.servers);
        // Ensure the selected country filter remains active
        selectCountryFilter.value = countryFilter;

        // Format last updated timestamp (24-hour format)
        const updatedAt = new Date(data.updated_at);
        const formattedDate = updatedAt.toLocaleString(undefined, {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false, // 24-hour clock
        });

        // Live status counts are no longer relevant without the 'Status' column
        // but keeping the metadata structure consistent for now.
        // If you want to completely remove this, you can adjust the metadataDiv.innerHTML
        // const onlineServers = filteredServers.filter(s => s.simulatedStatus === 'Online').length;
        // const offlineServers = filteredServers.length - onlineServers;

        // Show metadata
        metadataDiv.innerHTML = `
      <p class="font-medium"><strong>Total Servers:</strong> <span class="font-bold text-blue-700">${data.total_servers}</span></p>
      <p class="font-medium"><strong>Last Updated:</strong> <span class="font-bold text-blue-700">${formattedDate}</span></p>
      <!-- Removed live status as columns are removed -->
    `;

        // Populate table rows with server data
        tbody.innerHTML = "";
        if (filteredServers.length > 0) {
          filteredServers.forEach((server, idx) => {
            const ipv6Class =
              server.ipv6_capable === "yes"
                ? "text-green-600 font-semibold"
                : "text-red-600 font-semibold";
            const httpsClass =
              server.https_functional === 1
                ? "text-green-600 font-semibold"
                : "text-red-600 font-semibold";

            tbody.innerHTML += `
          <tr class="${idx % 2 === 0 ? "bg-white" : "bg-gray-50"} hover:bg-blue-50 transition duration-150 ease-in-out">
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-800 sm:px-6 sm:py-4">${idx + 1}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 sm:px-6 sm:py-4">${server.name}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 sm:px-6 sm:py-4">${server.country}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 sm:px-6 sm:py-4">${server.sponsor}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 sm:px-6 sm:py-4">${server.id}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm ${httpsClass} sm:px-6 sm:py-4">${server.https_functional === 1 ? "Yes" : "No"}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm ${ipv6Class} sm:px-6 sm:py-4">${server.ipv6_capable}</td>
            <td
                class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 font-mono sm:px-6 sm:py-4 cursor-help relative"
                data-ipv4="${server.ip_address?.A || ""}"
                data-ipv6="${server.ip_address?.AAAA || ""}"
            >
                ${server.hostname}
            </td>
          </tr>`;
          });
        } else {
          // Colspan is now 8
          tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500 italic">No servers found matching your criteria.</td></tr>`;
        }
      }

      // Function to trigger re-rendering with current filters
      function applyFilters() {
        const selectedIsp = selectProvider.value;
        const selectedCountry = selectCountryFilter.value;
        const searchTerm = searchServersInput.value;
        loadServers(selectedIsp, selectedCountry, searchTerm);
      }

      // Event listeners for filters
      selectProvider.addEventListener("change", () => {
        // When ISP changes, reset country filter and search term, then load
        selectCountryFilter.value = "";
        searchServersInput.value = "";
        applyFilters();
      });
      selectCountryFilter.addEventListener("change", applyFilters);
      searchServersInput.addEventListener("input", applyFilters);

      // --- Tooltip Event Listeners ---
      tbody.addEventListener("mouseover", (e) => {
        const hoveredCell = e.target.closest("td");

        // Ensure the hovered element is the last column (Host) and contains IP data
        // The index is now 7 (0-indexed), as 4 columns were removed from the original 11th index.
        if (
          hoveredCell &&
          hoveredCell.cellIndex === 7 &&
          hoveredCell.hasAttribute("data-ipv4")
        ) {
          const ipv4 = hoveredCell.dataset.ipv4;
          const ipv6 = hoveredCell.dataset.ipv6;

          let tooltipContent = `<p><strong>IPv4:</strong> ${ipv4 || "N/A"}</p>`;
          if (ipv6) {
            tooltipContent += `<p><strong>IPv6:</strong> ${ipv6}</p>`;
          }
          ipTooltip.innerHTML = tooltipContent;

          // Position the tooltip relative to the hovered cell
          const rect = hoveredCell.getBoundingClientRect();
          const tooltipWidth = ipTooltip.offsetWidth;
          const tooltipHeight = ipTooltip.offsetHeight;

          // Calculate position relative to the document
          let top = rect.bottom + window.scrollY + 10; // 10px below the cell
          let left = rect.left + window.scrollX;

          // Adjust if too close to the right edge of the viewport
          if (left + tooltipWidth > window.innerWidth - 20) {
            left = window.innerWidth - tooltipWidth - 20; // 20px padding from right
          }
          // Ensure it doesn't go off the left edge of the viewport
          if (left < 10) {
            left = 10;
          }

          ipTooltip.style.top = `${top}px`;
          ipTooltip.style.left = `${left}px`;
          ipTooltip.classList.add("visible");
        }
      });

      tbody.addEventListener("mouseout", (e) => {
        // Hide the tooltip when the mouse leaves the tbody area
        ipTooltip.classList.remove("visible");
      });

      // Start everything when page loads
      document.addEventListener("DOMContentLoaded", loadProviders);
    </script>
  </body>
</html>
